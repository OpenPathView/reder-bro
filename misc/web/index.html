<!DOCTYPE html>
<html>
    <head>
        <title>OPV Mobile Controler</title>
        

        <link rel="stylesheet" href="static/leaflet.css" />
        <script src="static/leaflet.js"></script>

        <script type="text/javascript">

            var qs = function(s){
                return document.querySelector(s);
            };

            var ws = new function(){
                this.ws = null;

                this.openSocket = function(){

                    this.ws = new WebSocket(qs("#ws_url").value, "protocolOne");
                    

                    this.ws.onopen = function(e){
                        console.log("WebSocket opened, event :");
                        console.log(e);
                        qs("#connectionInfos").style.display = "none";    
                        qs("#controles").style.display = null;    
                    };

                    this.ws.onerror = function(e){
                        console.log("Error, event :");
                        console.log(e);
                    };

                    window.onbeforeunload = function(){
                        this.close();
                        alert("WebSocket connexion closed");
                    };

                    this.ws.onclose = function(e){
                        console.log("WebSocket closed, event :");
                        console.log(e);
                        qs("#connectionInfos").style.display = null;    
                        qs("#controles").style.display = "none";
                        this.close();
                        alert("WebSocket connexion closed");
                    };
                    
                    this.ws.onmessage = function(e){
                        var rep = JSON.parse(e.data);
                        console.log(rep);
                
                        if( rep.hasOwnProperty('pos') ){
                            qs("#lat").innerHTML="lat"+rep.pos.lat;
                            qs("#lon").innerHTML="long"+rep.pos.long;
                            qs("#alt").innerHTML="alt"+rep.pos.alt;
                            qs("#rad").innerHTML="rad"+rep.pos.rad;
                        }
                        else if(rep.hasOwnProperty('config')){
                            if (rep.auto == "True"){
                                qs("#mode").value = rep.dist                                
                            }
                            else{
                                qs("#mode").value = 0
                            }
                        }
                        else if(rep.hasOwnProperty('pano')){
                            console.log(rep);
                            // TODO : add map with panorama coordinates and user position
                            // '{"pano" : {"lat": "%F", lon:"%F", alt:"%F", rad:"%s"}}'
                        }
                        else if(rep.hasOwnProperty('succes')){
                            if(rep.succes=="false"){
                                alert("echec du serveur")
                            }
                        }

                    };
                };

                this.setAutoMode = function(){
                    selectedDist = qs("#mode").value
                    var data = { set: "automode", dist: selectedDist};
                    this.ws.send( JSON.stringify(data) );            
                };
                
                this.turnOn = function(){
                    var data = { action: "turnon" };
                    this.ws.send( JSON.stringify(data) );                
                };

                this.turnOff = function(){
                    var data = { action: "turnoff" };
                    this.ws.send( JSON.stringify(data) );                
                };

                this.takePic = function(){
                    var data = { action: "takepic" };
                    this.ws.send( JSON.stringify(data) );                
                };

            }();
        
        </script>
    </head>

    <body>
        <div id="connectionInfos">
            <label>URL de connection : <input type="text" id="ws_url" value="ws://192.168.0.42:9876/"></label>
            <button onclick="ws.openSocket()">Connect</button><br>
        </div>

        <div id="controles" style="display:none;">
            <div id="geoInfos">
                <p id="lat"></p>
                <p id="lon"></p>
                <p id="alt"></p>
                <p id="rad"></p>
            </div>

            <div id="settings">
                <p>Mode : 
                    <select id="mode" onchange="ws.setAutoMode()">
                        <option value = "0">0ff</option>
                        <option value = "5">5</option>
                        <option value = "10">10</option>
                        <option value = "15">15</option>
                        <option value = "20">20</option>
                        <option value = "30">30</option>
                        <option value = "35">35</option>
                        <option value = "30">30</option>
                        <option value = "35">35</option>                
                        <option value = "40">40</option>
                        <option value = "45">45</option>
                        <option value = "50">50</option>
                    </select>
                </p>
            </div>

            <div id="buttons">
                <button type="button" onclick="ws.turnOn()">Turn On</button>
                <button type="button" onclick="ws.turnOff()">Turn Off</button>
                <button type="button" onclick="ws.takePic()">Take picture</button>
            </div>

            <div id="map" style="height: 500px;">
                <!-- Will contain the map -->
            </div>
        </div>
        <script type="text/javascript">
            var map = L.map('map').setView([48.41416, -4.47197], 13);
            L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',
                maxZoom: 18
            }).addTo(map);
            map.attributionControl.setPrefix(''); // Don't show the 'Powered by Leaflet' text. Attribution overload

/*            L.tileLayer('http://{s}.tiles.mapbox.com/v3/MapID/{z}/{x}/{y}.png', {
                attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
                maxZoom: 18
                }).addTo(map);*/
        </script>


    </body>
</html>
